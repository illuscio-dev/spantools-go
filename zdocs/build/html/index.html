

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Spantools-Go &mdash; spantools 0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="#" class="icon icon-home"> spantools
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Spantools-Go</a></li>
<li><a class="reference internal" href="#encoding-goals">Encoding Goals</a></li>
<li><a class="reference internal" href="#encoding-quickstart">Encoding Quickstart</a><ul>
<li><a class="reference internal" href="#declare-a-contentengine">Declare a ContentEngine</a></li>
<li><a class="reference internal" href="#decode-a-payload">Decode a Payload</a></li>
<li><a class="reference internal" href="#decode-a-payload-of-an-unknown-type">Decode a Payload of an Unknown Type</a></li>
<li><a class="reference internal" href="#encode-a-payload">Encode a Payload</a></li>
<li><a class="reference internal" href="#register-a-new-encoder">Register a New Encoder</a></li>
<li><a class="reference internal" href="#extend-spanengine">Extend SpanEngine</a></li>
<li><a class="reference internal" href="#register-a-json-extension">Register a JSON Extension</a></li>
<li><a class="reference internal" href="#register-a-bson-codec">Register a BSON Codec</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-errors">API Errors</a></li>
<li><a class="reference internal" href="#paging-models">Paging Models</a></li>
<li><a class="reference internal" href="#api-documentation">API documentation</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">spantools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#">Docs</a> &raquo;</li>
        
      <li>Spantools-Go</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="spantools-go">
<h1>Spantools-Go<a class="headerlink" href="#spantools-go" title="Permalink to this headline">¶</a></h1>
<p>Spantools is a shared library for enabling spanreed-style communication between
microservices.</p>
</div>
<div class="section" id="encoding-goals">
<h1>Encoding Goals<a class="headerlink" href="#encoding-goals" title="Permalink to this headline">¶</a></h1>
<p>spantools/encoding’s goal is to make a single interface specification for any given
content type, and enable the following features:</p>
<ol class="arabic simple">
<li><p>Services can determine request and response content types dynamically based on
message headers or mimetype sniffing.</p></li>
<li><p>Remove need to call encoding-specific methods for decode.</p></li>
<li><p>Clients can send arbitrary object serializations and request back whichever
encoding type they are most comfortable with.</p></li>
<li><p>Service developers do not have to explicitly add support for encoding types to a
given service or handler. Support for a mimetype should be able to be added once
to a shared library and gotten for free by an entire ecosystem.</p></li>
<li><p>Content encoding and decoding support should be independent of service pattern.
IE, adding support for understanding yaml should upgrade both REST server and
http client libraries on a rebuild.</p></li>
<li><p>Developers can easily extend all of their services to support a new content type
by creating their own encoding.</p></li>
<li><p>All default encoding shipped with spantools can be easily extended to handle
custom types and types from third-party packaged used by the service.</p></li>
<li><p>When possible, developers are able to define handlers for third party types for each
encoding type. This allows the use of convenient third party data types that do not
define a marshaller or unmarshaller function for a given encoding without having to
wrap them in a new type.</p></li>
</ol>
</div>
<div class="section" id="encoding-quickstart">
<h1>Encoding Quickstart<a class="headerlink" href="#encoding-quickstart" title="Permalink to this headline">¶</a></h1>
<p>Spantools offers a consistent interface for encoding / decoding arbitrary content
encoding types.</p>
<div class="section" id="declare-a-contentengine">
<h2>Declare a ContentEngine<a class="headerlink" href="#declare-a-contentengine" title="Permalink to this headline">¶</a></h2>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;bytes&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;spantools/encoding&quot;</span>
    <span class="s">&quot;spantools/mimetype&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function, declare your engine:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">NewContentEngine</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;error creating content engine&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="decode-a-payload">
<h2>Decode a Payload<a class="headerlink" href="#decode-a-payload" title="Permalink to this headline">¶</a></h2>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Make our json content to decode</span>
<span class="nx">content</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&quot;name&quot;: &quot;Harry Potter&quot;, &quot;house&quot;: &quot;Potter&quot;}`</span><span class="p">)</span>
<span class="nx">contentBuffer</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>

<span class="c1">// Here&#39;s the type we are going to decode to</span>
<span class="kd">type</span> <span class="nx">Wizard</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&quot;name&quot; bson:&quot;name&quot;`</span>
    <span class="nx">House</span> <span class="kt">string</span> <span class="s">`json:&quot;house&quot; bson:&quot;name&quot;`</span>
<span class="p">}</span>

<span class="c1">// Declare a pointer to the wizard we want to unmarshall our json to</span>
<span class="nx">student</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Wizard</span><span class="p">)</span>

<span class="c1">// Ask the engine to decode the content</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">JSON</span><span class="p">,</span> <span class="nx">student</span><span class="p">,</span> <span class="nx">contentBuffer</span><span class="p">)</span> <span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Display the result</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%+v\n&quot;</span><span class="p">,</span> <span class="nx">student</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="p">{</span><span class="n">Name</span><span class="p">:</span><span class="n">Harry</span> <span class="n">Potter</span> <span class="n">House</span><span class="p">:</span><span class="n">Potter</span><span class="p">}</span>
</pre></div>
</div>
<p>Decoding other types can be accomplished by changing <code class="docutils literal notranslate"><span class="pre">mimetype.JSON</span></code> to a different
value.</p>
</div>
<div class="section" id="decode-a-payload-of-an-unknown-type">
<h2>Decode a Payload of an Unknown Type<a class="headerlink" href="#decode-a-payload-of-an-unknown-type" title="Permalink to this headline">¶</a></h2>
<p>To decode content of an unknown mimetype, use:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">,</span> <span class="nx">student</span><span class="p">,</span> <span class="nx">contentBuffer</span><span class="p">)</span> <span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The engine will attempt to decode the</p>
</div>
<div class="section" id="encode-a-payload">
<h2>Encode a Payload<a class="headerlink" href="#encode-a-payload" title="Permalink to this headline">¶</a></h2>
<p>Let’s encode a struct to JSON:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">wizard</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Wizard</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span>  <span class="s">&quot;Draco Malfoy&quot;</span><span class="p">,</span>
        <span class="nx">House</span><span class="p">:</span> <span class="s">&quot;Slytherin&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">contentBuffer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">JSON</span><span class="p">,</span> <span class="nx">wizard</span><span class="p">,</span> <span class="nx">contentBuffer</span><span class="p">)</span> <span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%+v\n&quot;</span><span class="p">,</span> <span class="nx">contentBuffer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</pre></div>
</div>
<p>Encoding to BSON is as easy as changing the format:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">BSON</span><span class="p">,</span> <span class="nx">wizard</span><span class="p">,</span> <span class="nx">contentBuffer</span><span class="p">)</span> <span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>BSON is offered as default format for faster fetching from MongoDB when a record just
need to be passed along.</p>
</div>
<div class="section" id="register-a-new-encoder">
<h2>Register a New Encoder<a class="headerlink" href="#register-a-new-encoder" title="Permalink to this headline">¶</a></h2>
<p>Let’s define an encoder/decoder for text/csv. First, create a type to implement the
encoder.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">YamlEncoder</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// This method implements the encoding.Decoder type.</span>
<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">YamlEncoder</span><span class="p">)</span> <span class="nx">Decode</span><span class="p">(</span>
    <span class="nx">engine</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">ContentEngine</span><span class="p">,</span> <span class="nx">reader</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">contentReceiver</span> <span class="kd">interface</span><span class="p">{},</span>
<span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">contentBuffer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">contentBuffer</span><span class="p">.</span><span class="nx">ReadFrom</span><span class="p">(</span><span class="nx">reader</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error reading content: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// This encoder / decoder is going to be a wrapper around the go-yaml library.</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">yaml</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">contentBuffer</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">(),</span> <span class="nx">contentReceiver</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error unmarshalling yaml: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// This method implements the encoding.Encoder type.</span>
<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">YamlEncoder</span><span class="p">)</span> <span class="nx">Encode</span><span class="p">(</span>
    <span class="nx">engine</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">ContentEngine</span><span class="p">,</span> <span class="nx">writer</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">content</span> <span class="kd">interface</span><span class="p">{},</span>
<span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">contentBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">yaml</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error marshalling yaml: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">writer</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">contentBytes</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error writing yaml: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Define a data model to unmarshal from / marshal to:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Wizard</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`yaml:&quot;name&quot;`</span>
    <span class="nx">House</span> <span class="kt">string</span> <span class="s">`yaml:&quot;house&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our <code class="docutils literal notranslate"><span class="pre">main()</span></code> function, create a new engine and register the encoder to it:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">NewContentEngine</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Make the encoder / decoder instance</span>
<span class="nx">yamlEncoder</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">YamlEncoder</span><span class="p">)</span>

<span class="c1">// Register for encoding:</span>
<span class="nx">engine</span><span class="p">.</span><span class="nx">SetEncoder</span><span class="p">(</span><span class="s">&quot;application/yaml&quot;</span><span class="p">,</span> <span class="nx">yamlEncoder</span><span class="p">)</span>

<span class="c1">// Register for decoding:</span>
<span class="nx">engine</span><span class="p">.</span><span class="nx">SetDecoder</span><span class="p">(</span><span class="s">&quot;application/yaml&quot;</span><span class="p">,</span> <span class="nx">yamlEncoder</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the above example, we use <code class="docutils literal notranslate"><span class="pre">&quot;application/yaml&quot;</span></code> as the mimetype. You can also
use <code class="docutils literal notranslate"><span class="pre">mimetype.YAML</span></code> which is an alias for <code class="docutils literal notranslate"><span class="pre">&quot;application/yaml&quot;</span></code>.</p>
</div>
<p>Now lets test it:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">yamlString</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;name: Hermione Granger\nhouse: Gryffindor&quot;</span><span class="p">)</span>
<span class="nx">contentBuffer</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="nx">yamlString</span><span class="p">)</span>

<span class="c1">// Lets decode it into a wizard</span>
<span class="nx">wizard</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Wizard</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="s">&quot;application/yaml&quot;</span><span class="p">,</span> <span class="nx">wizard</span><span class="p">,</span> <span class="nx">contentBuffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Print the decoded object</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;\nDECODED:\n%+v\n&quot;</span><span class="p">,</span> <span class="nx">wizard</span><span class="p">)</span>

<span class="c1">// Encode the object into a YAML binary</span>
<span class="nx">encodeBuffer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="s">&quot;application/yaml&quot;</span><span class="p">,</span> <span class="nx">wizard</span><span class="p">,</span> <span class="nx">encodeBuffer</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;\nENCODED:\n%+v\n&quot;</span><span class="p">,</span> <span class="nx">encodeBuffer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DECODED</span><span class="p">:</span>
<span class="o">&amp;</span><span class="p">{</span><span class="n">Name</span><span class="p">:</span><span class="n">Hermione</span> <span class="n">Granger</span> <span class="n">House</span><span class="p">:</span><span class="n">Gryffindor</span><span class="p">}</span>

<span class="n">ENCODED</span><span class="p">:</span>
<span class="n">name</span><span class="p">:</span> <span class="n">Hermione</span> <span class="n">Granger</span>
<span class="n">house</span><span class="p">:</span> <span class="n">Gryffindor</span>
</pre></div>
</div>
</div>
<div class="section" id="extend-spanengine">
<h2>Extend SpanEngine<a class="headerlink" href="#extend-spanengine" title="Permalink to this headline">¶</a></h2>
<p>It’s possible to extend the SpanEngine type.</p>
<p>Lets say we want an ContentEngine with an <code class="docutils literal notranslate"><span class="pre">AppName</span></code> field so that we can access it
in a custom encoder:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">CustomEngine</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">encoding</span><span class="p">.</span><span class="nx">SpanEngine</span>
    <span class="nx">AppName</span> <span class="kt">string</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now lets define a text Encoder that uses the engine while dumping the content:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">CustomTextEncoder</span> <span class="kd">struct</span> <span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">encoder</span> <span class="nx">CustomTextEncoder</span><span class="p">)</span> <span class="nx">Encode</span><span class="p">(</span>
    <span class="nx">engine</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">ContentEngine</span><span class="p">,</span> <span class="nx">writer</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">content</span> <span class="kd">interface</span><span class="p">{},</span>
<span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// Make a type assert to convert the engine interface passed in to the encoder</span>
    <span class="c1">// to our engine type.</span>
    <span class="nx">ourEngine</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.(</span><span class="o">*</span><span class="nx">CustomEngine</span><span class="p">)</span>

    <span class="c1">// This Encoder is only going to accept strings, so we&#39;re going to assert the</span>
    <span class="c1">// type here.</span>
    <span class="nx">contentString</span> <span class="o">:=</span> <span class="nx">content</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
    <span class="nx">contentString</span> <span class="p">=</span> <span class="nx">ourEngine</span><span class="p">.</span><span class="nx">AppName</span> <span class="o">+</span> <span class="s">&quot; says: &#39;&quot;</span> <span class="o">+</span> <span class="nx">contentString</span> <span class="o">+</span> <span class="s">&quot;&#39;.&quot;</span>

    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">writer</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">contentString</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;error writing text to payload: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our <code class="docutils literal notranslate"><span class="pre">main()</span></code> function we can make our new engine by embedding the default one:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">NewContentEngine</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">ourEngine</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CustomEngine</span><span class="p">{</span>
    <span class="nx">SpanEngine</span><span class="p">:</span> <span class="nx">engine</span><span class="p">,</span>
    <span class="nx">AppName</span><span class="p">:</span> <span class="s">&quot;MyAwesomeApp&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we need to signal to the underlying spanEngine to pass in our custom engine to the
Encoder.Encode() and Encoder.Decode() app:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ourEngine</span><span class="p">.</span><span class="nx">SetPassedEngine</span><span class="p">(</span><span class="nx">ourEngine</span><span class="p">)</span>
</pre></div>
</div>
<p>Register our encoder. It will replace the default text/plain encoder:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ourEngine</span><span class="p">.</span><span class="nx">SetEncoder</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">CustomTextEncoder</span><span class="p">{})</span>
</pre></div>
</div>
<p>Now we can use the engine as normal:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">ourEngine</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">,</span> <span class="s">&quot;some message&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;ENCODED:&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ENCODED</span><span class="p">:</span> <span class="n">MyAwesomeApp</span> <span class="n">says</span><span class="p">:</span> <span class="s1">&#39;some message&#39;</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="register-a-json-extension">
<h2>Register a JSON Extension<a class="headerlink" href="#register-a-json-extension" title="Permalink to this headline">¶</a></h2>
<p>SpanEngine uses <a class="reference external" href="http://ugorji.net/blog/go-codec-primer">go-codec</a> for json encoding and decoding which allows the registration of
<a class="reference external" href="http://ugorji.net/blog/go-codec-primer#using-extensions">extensions</a> for custom
named types.</p>
<p>Lets say we have a type defined in a third party package that looks like this:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Fraction</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Nominator</span> <span class="kt">int</span>
    <span class="nx">Denominator</span> <span class="kt">int</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We want to have access to it’s methods, but it does not define any of the interfaces
that <a class="reference external" href="http://ugorji.net/blog/go-codec-primer">go-codec</a> cues off of (json.Marshaler, json.Unmarshaler, json.TextMarshaler,
etc…). We can define an extension for it using
<a class="reference external" href="http://ugorji.net/blog/go-codec-primer#using-extensions">go-codec’s extensions</a>:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">FractionExtension</span> <span class="kd">struct</span> <span class="p">{}</span>

<span class="c1">// Encodes value to string with format &#39;nominator/denominator&#39;.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">*</span><span class="nx">FractionExtension</span><span class="p">)</span> <span class="nx">ConvertExt</span><span class="p">(</span><span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
    <span class="nx">valueFraction</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Fraction</span><span class="p">)</span>

    <span class="nx">valueString</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">valueFraction</span><span class="p">.</span><span class="nx">Nominator</span><span class="p">)</span> <span class="o">+</span>
        <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">valueFraction</span><span class="p">.</span><span class="nx">Nominator</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">valueString</span>
<span class="p">}</span>

<span class="c1">// Decodes value from string with format &#39;nominator/denominator&#39;.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">*</span><span class="nx">FractionExtension</span><span class="p">)</span> <span class="nx">UpdateExt</span><span class="p">(</span><span class="nx">dest</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">destVal</span> <span class="o">:=</span> <span class="nx">dest</span><span class="p">.(</span><span class="o">*</span><span class="nx">Fraction</span><span class="p">)</span>
    <span class="nx">fracString</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>

    <span class="nx">split</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">fracString</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">xerrors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not convert &#39;&quot;</span> <span class="o">+</span> <span class="nx">fracString</span> <span class="o">+</span> <span class="s">&quot;&#39; to string&quot;</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nx">nominator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span>  <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span>
            <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
                <span class="s">&quot;error converting nominator of &#39;&quot;</span> <span class="o">+</span>
                    <span class="nx">fracString</span> <span class="o">+</span> <span class="s">&quot;&#39; to frac: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">denominator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span>  <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span>
            <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
                <span class="s">&quot;error converting denominator of&#39;&quot;</span> <span class="o">+</span>
                    <span class="nx">fracString</span> <span class="o">+</span> <span class="s">&quot;&#39; to frac: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="nx">destVal</span> <span class="p">=</span> <span class="nx">Fraction</span><span class="p">{</span>
        <span class="nx">Nominator</span><span class="p">:</span>   <span class="nx">nominator</span><span class="p">,</span>
        <span class="nx">Denominator</span><span class="p">:</span> <span class="nx">denominator</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now lets create a list of extensions to register with the engine using the
encoding.JsonExtensionOpts type:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">jsonExtensions</span> <span class="p">=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">encoding</span><span class="p">.</span><span class="nx">JsonExtensionOpts</span><span class="p">{</span>
    <span class="p">{</span>
        <span class="c1">// The value type this extension should act on</span>
        <span class="nx">ValueType</span><span class="p">:</span>    <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">Fraction</span><span class="p">{}),</span>

        <span class="c1">// The extension itself.</span>
        <span class="nx">ExtInterface</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">FractionExtension</span><span class="p">{},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now in our <code class="docutils literal notranslate"><span class="pre">main()</span></code> function we can create an engine and register our list of
extensions:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">NewContentEngine</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">AddJsonExtensions</span><span class="p">(</span><span class="nx">jsonExtensions</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now lets encode an object with a fraction value:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">HasRational</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Fraction</span> <span class="nx">Fraction</span>
<span class="p">}</span>

<span class="nx">ourObject</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">HasRational</span><span class="p">{</span><span class="nx">Fraction</span><span class="p">:</span> <span class="nx">Fraction</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">}}</span>

<span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">JSON</span><span class="p">,</span> <span class="nx">ourObject</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;DUMPED:&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DUMPED</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Fraction&quot;</span><span class="p">:</span><span class="s2">&quot;1/1&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>And now lets decode it again:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">decoded</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HasRational</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">JSON</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;LOADED: %+v\n&quot;</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOADED</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">{</span><span class="n">Fraction</span><span class="p">:{</span><span class="n">Nominator</span><span class="p">:</span><span class="mi">1</span> <span class="n">Denominator</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Why go-codec extensions?</strong></p>
<p>Spantools opts to use the go-codec/JsonHandler over the standard encoding/Json
because it allows you to define extensions for arbitrary third-party types.</p>
<p>We can make codecs to handle bson’s primitives.Binary for instance rather than
having to wrap it in a new type and define a marshal/unmarshal function on THAT,
which in turn reduces the mental overhead of using some fields where our real
type is embedded.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Default Json Extensions</strong></p>
<p>SpanEngine ships with the following types handled:</p>
<ul class="simple">
<li><p>UUIDs from <a class="reference external" href="github.com/satori/go.uuid">go.uuid</a></p></li>
<li><p>Binary blob data represented as <code class="docutils literal notranslate"><span class="pre">spantypes.BinData</span></code> are represented as a hex
string.</p></li>
<li><p><a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson/primitive#Binary">Bson primitive.Binary</a> data will be encoded as a string for 0x3 subtype (UUID)
and a hex string for 0x0 subtype (arbitrary binary data). Other subtypes are not
currently supported and will panic.</p></li>
<li><p><a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson#Raw">bson.Raw</a> is unmarshaled to a <code class="docutils literal notranslate"><span class="pre">map[string]interface{}</span></code> and THEN encoded to a
json object. Included to enable the direct return of a Bson document from a mongo
database.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Named types can implement json.Marshaler, json.TextMarshaler, or codec.Selfer for
marshaling and their unmarshaling counterparts to handle encoding and decoding.
<code class="docutils literal notranslate"><span class="pre">spantypes.BinData</span></code> is handled in this manner.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Bson Types: Encode-Only</strong></p>
<p>The <a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson#Raw">bson.Raw</a> and <a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson/primitive#Binary">primitive.Binary</a> type extensions supply ENCODING-ONLY
methods, and will panic if a stuct uses these types as a target. They are supplied
to enable the direct conversion of bson documents to json, not to enable their use
in business-logic structs.</p>
<p>It is recommended that the following types be used as intermediaries in stucts:</p>
<ul class="simple">
<li><p>Bson UUIDs (<a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson/primitive#Binary">primitive.Binary</a> subtype 0x3) should be represented with <a class="reference external" href="github.com/satori/go.uuid">go.uuid</a>
UUID objects. SpanEngine comes with codecs to seamlessly handle the conversion
of this type in and out of BSON.</p></li>
<li><p>Bson Binary blob (primitive.Binary subtype 0x3) should be represented as
<code class="docutils literal notranslate"><span class="pre">spantypes.BinData</span></code>. The bson encoder has a codec to handle the encoding /
decoding of this type in and out of Bson.</p></li>
</ul>
</div>
</div>
<div class="section" id="register-a-bson-codec">
<h2>Register a BSON Codec<a class="headerlink" href="#register-a-bson-codec" title="Permalink to this headline">¶</a></h2>
<p>The official bson driver has a system very similar to codec’s extensions, which through
sheer happenstance is called a
<a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson/bsoncodec#ValueCodec">ValueCodec interface</a>.</p>
<p>Lets take an example.</p>
<p>Say we have a type defined in a third-party package we want to handle:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Fraction</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Nominator</span> <span class="kt">int</span>
    <span class="nx">Denominator</span> <span class="kt">int</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can define a codec for it like so:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">FractionCodec</span> <span class="kd">struct</span> <span class="p">{}</span>

<span class="c1">// Encodes value</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">codec</span> <span class="o">*</span><span class="nx">FractionCodec</span><span class="p">)</span> <span class="nx">EncodeValue</span><span class="p">(</span>
    <span class="nx">encodeCTX</span> <span class="nx">bsoncodec</span><span class="p">.</span><span class="nx">EncodeContext</span><span class="p">,</span>
    <span class="nx">valueWriter</span> <span class="nx">bsonrw</span><span class="p">.</span><span class="nx">ValueWriter</span><span class="p">,</span>
    <span class="nx">value</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span>
<span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fractionValue</span> <span class="o">*</span><span class="nx">Fraction</span>

    <span class="k">switch</span> <span class="nx">incomingType</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">Interface</span><span class="p">().(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="nx">Fraction</span><span class="p">:</span>
        <span class="nx">fractionValue</span> <span class="p">=</span> <span class="nx">incomingType</span>
    <span class="k">case</span> <span class="nx">Fraction</span><span class="p">:</span>
        <span class="nx">fractionValue</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">incomingType</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;Error encoding fraction.&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">valueString</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">fractionValue</span><span class="p">.</span><span class="nx">Nominator</span><span class="p">)</span> <span class="o">+</span>
        <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">fractionValue</span><span class="p">.</span><span class="nx">Nominator</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">valueWriter</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">valueString</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Decodes value</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">codec</span> <span class="o">*</span><span class="nx">FractionCodec</span><span class="p">)</span> <span class="nx">DecodeValue</span><span class="p">(</span>
    <span class="nx">decodeCTX</span> <span class="nx">bsoncodec</span><span class="p">.</span><span class="nx">DecodeContext</span><span class="p">,</span>
    <span class="nx">valueReader</span> <span class="nx">bsonrw</span><span class="p">.</span><span class="nx">ValueReader</span><span class="p">,</span>
    <span class="nx">value</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span>
<span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">fracString</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">valueReader</span><span class="p">.</span><span class="nx">ReadString</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">split</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">fracString</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;could not convert &#39;&quot;</span> <span class="o">+</span> <span class="nx">fracString</span> <span class="o">+</span> <span class="s">&quot;&#39; to string&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">nominator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span>  <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
            <span class="s">&quot;error converting nominator of &#39;&quot;</span> <span class="o">+</span>
                <span class="nx">fracString</span> <span class="o">+</span> <span class="s">&quot;&#39; to frac: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">denominator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span>  <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span>
            <span class="s">&quot;error converting denominator of&#39;&quot;</span> <span class="o">+</span>
                <span class="nx">fracString</span> <span class="o">+</span> <span class="s">&quot;&#39; to frac: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">fraction</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Fraction</span><span class="p">{</span>
        <span class="nx">Nominator</span><span class="p">:</span>   <span class="nx">nominator</span><span class="p">,</span>
        <span class="nx">Denominator</span><span class="p">:</span> <span class="nx">denominator</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span> <span class="p">{</span>
        <span class="nx">value</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">fraction</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">value</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="o">*</span><span class="nx">fraction</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now lets create a list of codecs to register with the engine using the
encoding.BsonCodecOpts type:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">bsonCodecs</span> <span class="p">=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">encoding</span><span class="p">.</span><span class="nx">BsonCodecOpts</span><span class="p">{</span>
    <span class="p">{</span>
        <span class="nx">ValueType</span><span class="p">:</span>    <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">Fraction</span><span class="p">{}),</span>
        <span class="nx">Codec</span><span class="p">:</span>                <span class="o">&amp;</span><span class="nx">FractionCodec</span><span class="p">{},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our <code class="docutils literal notranslate"><span class="pre">main()</span></code> function, create the engine and register the codecs:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">NewContentEngine</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">AddBsonCodecs</span><span class="p">(</span><span class="nx">bsonCodecs</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here is the form type that has our fraction that we want to send / receive as bson:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">HasRational</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Fraction</span> <span class="nx">Fraction</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let’s encode one:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">ourObject</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">HasRational</span><span class="p">{</span><span class="nx">Fraction</span><span class="p">:</span> <span class="nx">Fraction</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">}}</span>

<span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">BSON</span><span class="p">,</span> <span class="nx">ourObject</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;DUMPED:&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DUMPED</span><span class="p">:</span> <span class="n">fraction1</span><span class="o">/</span><span class="mi">1</span>
</pre></div>
</div>
<p>Decoding it again:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="nx">decoded</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HasRational</span><span class="p">)</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="nx">mimetype</span><span class="p">.</span><span class="nx">BSON</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;LOADED: %+v\n&quot;</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOADED</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">{</span><span class="n">Fraction</span><span class="p">:{</span><span class="n">Nominator</span><span class="p">:</span><span class="mi">1</span> <span class="n">Denominator</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Default Bson ValueCodecs</strong></p>
<p>SpanEngine ships with the following types handled:</p>
<ul class="simple">
<li><p>UUIDs from <a class="reference external" href="github.com/satori/go.uuid">go.uuid</a> are converted to/from <a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson/primitive#Binary">primitive.Binary</a> subtype 0x3.</p></li>
<li><p>Binary blob data represented as <code class="docutils literal notranslate"><span class="pre">spantypes.BinData</span></code> are converted to/from
<a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson/primitive#Binary">primitive.Binary</a> subtype 0x0.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Named types can implement bsoncodec.ValueMarshaler and bsoncodec.ValueUnmarshaler
to handle encoding and decoding. <code class="docutils literal notranslate"><span class="pre">spantypes.BinData</span></code> is handled in this manner.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Handling Multiple Bson Docs</strong></p>
<p>Bson does not define a top-level list object for sending multiple documents over the
wire. When marshalling to / unmarshalling from a list of objects, SpanEngine uses
the “u241E” character to denote breaks between documents.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">string</span></code> version of this delimiter is held in the
<code class="docutils literal notranslate"><span class="pre">encoding.BsonListSepString</span></code> const, and the <code class="docutils literal notranslate"><span class="pre">[]byte</span></code> version is
<code class="docutils literal notranslate"><span class="pre">encoding.BsonListBytes</span></code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Accessing the bson codec registry</strong></p>
<p>If you wish to use the bson registry yourself for encoding / decoding to your
database, it is made accessible through <code class="docutils literal notranslate"><span class="pre">SpanEngine.BsonRegistry()</span></code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not add codecs directly to the registry returned by
<code class="docutils literal notranslate"><span class="pre">SpanEngine.BsonRegistry()</span></code>. <code class="docutils literal notranslate"><span class="pre">SpanEngine.AddBsonCodecs(bsonCodecs)</span></code> also
updates the JsonExtension for encoding the <a class="reference external" href="https://godoc.org/go.mongodb.org/mongo-driver/bson#Raw">bson.Raw</a> type to include all codecs
being added. Side-stepping it may cause panics when dumping a database document
directly to json.</p>
</div>
</div>
</div>
<div class="section" id="api-errors">
<h1>API Errors<a class="headerlink" href="#api-errors" title="Permalink to this headline">¶</a></h1>
<p>APIError and exceptions that inherit from it are designed to be raised by spanserver
during the processing of a request, then transmitted back for handling.</p>
<p>API exceptions are found in this toolbox for libraries which wish to consume these
errors without installing spanserver and all of its dependencies.</p>
<p>These errors can be found in the <code class="docutils literal notranslate"><span class="pre">spantools.errors_api</span></code> package.</p>
</div>
<div class="section" id="paging-models">
<h1>Paging Models<a class="headerlink" href="#paging-models" title="Permalink to this headline">¶</a></h1>
<p>Paging models are designed to help spanserver / spanclient communicate about paging
information, and can be found in the <code class="docutils literal notranslate"><span class="pre">spantools.models</span></code></p>
</div>
<div class="section" id="api-documentation">
<h1>API documentation<a class="headerlink" href="#api-documentation" title="Permalink to this headline">¶</a></h1>
<p>API documentation is created using godoc and can be
<a class="reference external" href="_static/godoc-root.html">found here</a>.</p>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright &#39;2020, Illuscio&#39;

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>